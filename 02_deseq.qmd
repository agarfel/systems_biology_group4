---
title: "02_deseq.qmd"
format: html
editor: visual
---

### Load data

```{r}
geneCountMatrix_Ocular = read.csv("data/OcularGeneCountMatrix.csv")
geneCountMatrix_Spinal = read.csv("data/SpinalGeneCountMatrix.csv")

sample_metadata_Ocular = read.csv("data/OcularSampleMetadata.csv")
sample_metadata_Spinal = read.csv("data/SpinalSampleMetadata.csv")
```

### Inspect data

```{r}
nrow(geneCountMatrix_Ocular)
nrow(geneCountMatrix_Spinal)

colnames_count_matrix_ocular = colnames(geneCountMatrix_Ocular)
colnames_count_matrix_spinal = colnames(geneCountMatrix_Spinal)
sample_ids_ocular <- colnames_count_matrix_ocular[-c(1)]
sample_ids_spinal <- colnames_count_matrix_spinal[-c(1)]

all(sample_metadata_Ocular$sample_id_ocular == sample_ids_ocular)
all(sample_metadata_Spinal$sample_id_spinal == sample_ids_spinal)
```

### Load deseq

```{r}
library(DESeq2)

dds_ocular <- DESeqDataSetFromMatrix(countData = geneCountMatrix_Ocular[,c(-1)],
  colData = sample_metadata_Ocular,
  design = ~ mutation)

dds_spinal <- DESeqDataSetFromMatrix(countData = geneCountMatrix_Spinal[,c(-1)],
  colData = sample_metadata_Spinal,
  design = ~ mutation)
```

### PCA

```{r}
plotPCA(rlog(dds_ocular), intgroup=c("mutation"))

plotPCA(rlog(dds_spinal), intgroup=c("mutation"))
```

### Testing for DE

```{r}
dds_ocular <- DESeq(dds_ocular)
dds_spinal <- DESeq(dds_spinal)
```

```{r}
res_ocular <- results(dds_ocular,
                      contrast = c("mutation", "SOD1", "C9ORF72"))
res_spinal <- results(dds_spinal,
                      contrast = c("mutation", "SOD1", "C9ORF72"))

res_ocular
res_spinal
```

```{r}
n_sig_ocular <- sum(res_ocular$padj < 0.05, na.rm = TRUE)
n_sig_spinal <- sum(res_spinal$padj < 0.05, na.rm = TRUE)

n_sig_ocular
n_sig_spinal
```

### FCS

```{r}
library(fgsea)
library(msigdbr)

BP_df = msigdbr(species = "human", category = "C5", subcategory = "BP")
BP_list = split(BP_df$ensembl_gene, BP_df$gs_name)
```

```{r}

#res_ocular <- results(dds_ocular,
#  contrast = c("mutation","SOD1","C90RF72"))

myStats_ocular <- res_ocular[,"stat"]
myStats_spinal <- res_spinal[,"stat"]

names(myStats_ocular) <- rownames(res_ocular)
names(myStats_spinal) <- rownames(res_spinal)

# Remove the ensembl version in the names
clean_names_ocular <- sub("\\.\\d+$", "", names(myStats_ocular))
clean_names_spinal <- sub("\\.\\d+$", "", names(myStats_spinal))

names(myStats_ocular) <- clean_names_ocular
names(myStats_spinal) <- clean_names_spinal

myStats_ocular <- myStats_ocular[!is.na(names(myStats_ocular))]
myStats_spinal <- myStats_spinal[!is.na(names(myStats_spinal))]

myStats_ocular <- myStats_ocular[!is.na(myStats_ocular)]
myStats_spinal <- myStats_spinal[!is.na(myStats_spinal)]

myStats_ocular <- sort(myStats_ocular, decreasing = TRUE)
myStats_spinal <- sort(myStats_spinal, decreasing = TRUE)
```

```{r}
fg_ocular <- fgseaMultilevel(pathways = BP_list, stats = myStats_ocular,
                             minSize = 15, maxSize = 500, scoreType = "std")
fg_spinal <- fgseaMultilevel(pathways = BP_list, stats = myStats_spinal,
                             minSize = 15, maxSize = 500, scoreType = "std")
```

```{r}
fg_sig_ocular <- fg_ocular %>%
  arrange(padj) %>%
  filter(padj < 0.05)

fg_sig_spinal <- fg_spinal %>%
  arrange(padj) %>%
  filter(padj < 0.05)

nrow(fg_sig_ocular)
nrow(fg_sig_spinal)
```
